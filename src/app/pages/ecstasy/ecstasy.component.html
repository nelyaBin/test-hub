<!-- src/app/pages/ecstasy/ecstasy.component.html -->
<div class="load-test-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">Load Test Runner</h1>
    <p class="page-subtitle">Run and configure load tests using k6</p>
  </div>

  <!-- Configuration Section -->
  <div class="config-section">
    <!-- Form Section -->
    <app-load-test-form
      (componentChanged)="onComponentChanged($event)"
      (urlChanged)="onUrlChanged($event)"
      (testTypeChanged)="onTestTypeChanged($event)"
    />

    <!-- Graph Section -->
    <div class="config-card">
      <div class="section-header-with-toggle">
        <h3 class="section-title">
          <span class="section-icon">ğŸ“ˆ</span>
          Load Profile
        </h3>
        <div class="toggle-buttons-group">
          <button
            class="k6-phases-toggle"
            (click)="toggleK6Phases()"
            type="button"
            [class.active]="showK6Phases()"
          >
            <span class="toggle-icon">{{ showK6Phases() ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸' }}</span>
            <span>{{ showK6Phases() ? 'Hide' : 'Show' }} k6 Phases</span>
          </button>
          <button
            class="edit-mode-toggle"
            (click)="toggleEditMode()"
            type="button"
            [class.active]="isCustomMode()"
            title="Toggle edit mode"
          >
            <span class="toggle-icon">âœï¸</span>
            <span>{{ isCustomMode() ? 'Lock' : 'Edit' }} Curve</span>
          </button>
        </div>
      </div>

      <app-load-graph
        [controlPoints]="controlPoints()"
        [maxVUs]="maxVUs()"
        [totalDuration]="totalDurationInMinutes()"
        [isEditMode]="isCustomMode()"
        [showK6Phases]="showK6Phases()"
        [durationUnit]="durationUnit()"
        (pointAdded)="onPointAdded($event)"
        (pointUpdated)="onPointUpdated($event)"
        (pointDeleted)="onPointDeleted($event)"
      />

      <app-load-parameters
        [testType]="testType()"
        (virtualUsersChanged)="onVirtualUsersChanged($event)"
        (durationChanged)="onDurationChanged($event)"
        (durationUnitChanged)="onDurationUnitChanged($event)"
        (scenarioTypeChanged)="onScenarioTypeChanged($event)"
        (rampUpChanged)="onRampUpChanged($event)"
        (rampDownChanged)="onRampDownChanged($event)"
      />

      <!-- Control Points Summary -->
      @if (isCustomMode() && controlPoints().length > 0) {
        <div class="control-points-summary">
          <label class="input-label">Control Points</label>
          <div class="points-list">
            @for (point of controlPoints(); track $index) {
              <div class="point-item">
                <span class="point-time">{{ formatControlPointTime(point.time) }}</span>
                <span class="point-separator">â†’</span>
                <span class="point-vus">{{ point.vus }} VUs</span>
                @if (controlPoints().length > 2) {
                  <button
                    class="point-delete-btn"
                    type="button"
                    (click)="onPointDeleted($index)"
                    title="Delete point"
                  >
                    âœ•
                  </button>
                }
              </div>
            }
          </div>
        </div>
      }
    </div>

    <!-- Advanced Options -->
    <app-advanced-options
      (headersChanged)="onHeadersChanged($event)"
      (thresholdsChanged)="onThresholdsChanged($event)"
      (envVarsChanged)="onEnvVarsChanged($event)"
    />
  </div>

  <!-- Run Controls -->
  <div class="run-controls">
    <button
      class="run-button"
      [disabled]="!canRunTest()"
      (click)="runTest()"
      type="button"
    >
      <span class="run-icon">ğŸš€</span>
      <span>Run Load Test</span>
    </button>
    <div class="secondary-actions">
      <button class="secondary-button" type="button" (click)="saveAsPreset()">
        Save as Preset
      </button>
      <button
        class="secondary-button"
        type="button"
        (click)="resetConfiguration()"
      >
        Reset Configuration
      </button>
    </div>
  </div>

  <!-- Execution Status -->
  @if (executionStatus().status !== 'idle') {
    <app-execution-status
      [status]="executionStatus()"
      [totalDuration]="totalDurationInMinutes()"
      (viewResults)="viewResults()"
    />
  }

  <!-- Results Dashboard Iframe Modal -->
  @if (showResultsIframe()) {
    <div class="iframe-modal-overlay" (click)="closeResultsIframe()">
      <div class="iframe-modal-container" (click)="$event.stopPropagation()">
        <div class="iframe-modal-header">
          <div class="iframe-modal-title">
            <span class="modal-icon">ğŸ“Š</span>
            <h3>Load Test Results Dashboard</h3>
            <span class="test-id-badge">{{ executionStatus().testId }}</span>
          </div>
          <button
            class="close-iframe-btn"
            type="button"
            (click)="closeResultsIframe()"
          >
            âœ•
          </button>
        </div>
        <div class="iframe-content">
          <iframe
            [src]="getResultsUrl()"
            class="results-iframe"
            title="Load Test Results"
            frameborder="0"
            allowfullscreen
          >
          </iframe>
          <div class="iframe-loading">
            <div class="loading-spinner"></div>
            <p>Loading results dashboard...</p>
          </div>
        </div>
      </div>
    </div>
  }
</div>